<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=1.0, user-scalable=no">
    <link href="/m-css-st.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.3.js"></script>
    <title>레시피 </title>
</head>

<body>
<div id="recipeContent">
    <!-- 레시피 내용이 동적으로 삽입될 부분 -->
</div>
<div>
    <div class="r-card">
        <div class="r-top">

            <!-- <div class="fs80" style="">
                    <a href="" class="grey55">
                        <img src="/imgs/P_menu.svg" style="width:100%; height:7rem;">
                    </a>
            </div> -->

            <div class="mt1" style="width:50%;">
                <a href="" class="grey55">
                    <img src="/imgs/P_logo.svg" style="width:100%;">
                </a>
            </div>

            <!-- <div class="fs80">
                <a href="" class="grey55">
                    <img src="/imgs/P_search.svg" style="width:100%; height:88px;">
                </a>
            </div> -->
        </div>

        <div class="search-container">
            <!-- 검색창 -->
            <form id="searchForm" onsubmit="executeSearch(); return false;" class="formform" >
                <input type="text" id="searchInput" placeholder="레시피를 검색 해보세요" class="searchst" oninput="removeSpecialCharacters()">
                <button type="submit" class="search-button"><i class="fas fa-search"></i></button>
            </form>
        </div>

        <!-- 검색 결과 팝업 -->
        <div id="searchPopup" class="search-popup" onclick="closePopup1(event)">
            <div class="search-results" id="searchResults">
                <!-- 여기에 검색 결과가 동적으로 표시됩니다. -->
            </div>
        </div>

        <script>
            function removeSpecialCharacters() {
                const searchInput = document.getElementById('searchInput');
                searchInput.value = searchInput.value.replace(/[^\u3131-\u314e|\u314f-\u3163|\uac00-\ud7a3]/gi, '');

            }
            function executeSearch() {

                let searchInput = document.getElementById('searchInput').value;
                searchInput = searchInput.replace(/[^a-zA-Z0-9가-힣\s]/g, '');
                const searchParam = isNaN(searchInput) ? { 이름: searchInput } : { 항목일련번호: searchInput };

                $.ajax({
                    url: "/search",
                    type: "GET",
                    data: searchParam,
                    success: function(data) {

                        var searchResults = "<h3>검색 결과</h3>";
                        if (data.length === 0) {
                            searchResults += "<p>검색 결과가 없습니다.</p>";
                        } else {
                            data.forEach(function(item) {
                                searchResults += "<p> 이름: " + item.이름 + "</p>";
                                searchResults += "<a href='/recipe/" + item.항목일련번호 + "'>레시피 보기</a><br>";
                            });
                        }
                        document.getElementById('searchResults').innerHTML = searchResults;
                        document.getElementById('searchPopup').style.right = '0';
                    },
                    error: function() {
                        document.getElementById('searchResults').innerHTML = "<p>검색 중 오류가 발생했습니다.</p>";
                    }
                });
            }

            function closePopup1(event) {
                if (event.target.id === 'searchPopup') {
                    document.getElementById('searchPopup').style.right = '-300px';
                }
            }
        </script>

        <div>
            <img src="/imgs/P_mainimg.png" style="width:100%; border-radius:1rem;">
        </div>
        <div class="fs24 tac mt2 mb2 lsm10 grey77">
            Category
        </div>
        <div class="r-category-area mb2">
            <a href="" class="category-link" data-popup="#pop_txt1" data-category="미인차" style="text-decoration-line: none;">
                <div class="r-category-card r-c-bg1o">
                    <img src="/imgs/P_category_1.jpg" style="width:100%; ">
                    미인차
                </div>
            </a>
            <a href="" class="category-link" data-category="회춘차" style="text-decoration-line: none;">
                <div class="r-category-card r-c-bg2o">
                    <img src="/imgs/P_category_2.jpg" style="width:100%; ">
                    회춘차
                </div>
            </a>
            <a href="" class="category-link" data-category="원기회복" style="text-decoration-line: none;">
                <div class="r-category-card r-c-bg3o">
                    <img src="/imgs/P_category_3.jpg" style="width:100%; ">
                    원기회복차
                </div>
            </a>
            <a href="" class="category-link" data-category="방패차" style="text-decoration-line: none;">
                <div class="r-category-card r-c-bg4o">
                    <img src="/imgs/P_category_4.jpg" style="width:100%; ">
                    면역차
                </div>
            </a>
            <a href="" class="category-link" data-category="소염차" style="text-decoration-line: none;">
                <div class="r-category-card r-c-bg5o">
                    <img src="/imgs/P_category_5.jpg" style="width:100%; ">
                    항염차
                </div>
            </a>
            <a href="" style="text-decoration-line: none;" class="category-link" data-category="위장차">
                <div class="r-category-card r-c-bg6o">
                    <img src="/imgs/P_category_6.jpg" style="width:100%; ">
                    위장차
                </div>
            </a>
            <a href="" style="text-decoration-line: none;" class="category-link" data-category="안정차">
                <div class="r-category-card r-c-bg7o">
                    <img src="/imgs/P_category_7.jpg" style="width:100%; ">
                    안정차
                </div>
            </a>
            <a href="" style="text-decoration-line: none;" class="category-link" data-category="환절기차">
                <div class="r-category-card r-c-bg8o" >
                    <img src="/imgs/P_category_8.jpg" style="width:100%; ">
                    환절기차
                </div>
            </a>
            <a href="" style="text-decoration-line: none;" class="category-link" data-category="눈맑차">
                <div class="r-category-card r-c-bg9o">
                    <img src="/imgs/P_category_9.jpg" style="width:100%; ">
                    눈맑차
                </div>
            </a>
            <a href="" style="text-decoration-line: none;" class="category-link" data-category="매일차">
                <div class="r-category-card r-c-bg10o">
                    <img src="/imgs/P_category_10.jpg" style="width:100%; ">
                    매일차
                </div>
            </a>
            <a href="" style="text-decoration-line: none;" class="category-link" data-category="약손차">
                <div class="r-category-card r-c-bg11o">
                    <img src="/imgs/P_category_11.jpg" style="width:100%; ">
                    약손차
                </div>
            </a>
            <a href="" style="text-decoration-line: none;" class="category-link" data-category="항암차">
                <div class="r-category-card r-c-bg12o">
                    <img src="/imgs/P_category_12.jpg" style="width:100%; ">
                    항암차
                </div>
            </a>
            <a href="" style="text-decoration-line: none;" class="category-link" data-category="당뇨차">
                <div class="r-category-card r-c-bg13o">
                    <img src="/imgs/P_category_13.jpg" style="width:100%; ">
                    혈당차
                </div>
            </a>
            <a href="" style="text-decoration-line: none;" class="category-link" data-category="혈압차">
                <div class="r-category-card r-c-bg14o">
                    <img src="/imgs/P_category_14.jpg" style="width:100%; ">
                    혈압차
                </div>
            </a>
            <a href="" style="text-decoration-line: none;" class="category-link" data-category="심혈관차">
                <div class="r-category-card r-c-bg15o">
                    <img src="/imgs/P_category_15.jpg" style="width:100%; ">
                    심혈관차
                </div>
            </a>
            <a href="" style="text-decoration-line: none;" class="category-link" data-category="갑상선차">
                <div class="r-category-card r-c-bg16o">
                    <img src="/imgs/P_category_16.jpg" style="width:100%; ">
                    갑상선차
                </div>
            </a>
            <a href="" style="text-decoration-line: none;" class="category-link" data-category="통뼈차">
                <div class="r-category-card r-c-bg17o">
                    <img src="/imgs/P_category_17.jpg" style="width:100%; ">
                    관절염차
                </div>
            </a>
            <a href="" style="text-decoration-line: none;" class="category-link" data-category="부인차">
                <div class="r-category-card r-c-bg18o">
                    <img src="/imgs/P_category_18.jpg" style="width:100%; ">
                    부인차
                </div>
            </a>
        </div>
    </div>
</div>
<div class="containerb">
    <div class="layer_pop_txt" id="pop_txt1">
        <div class="pop_content">
            <ul class="popup-list grey55" id="popup-list">
            </ul>
            <div><a class="close_btn" href="javascript:void(0);" onclick="closePopup('#pop_txt1')">닫기</a></div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function() {
        // 팝업 닫기 버튼에 대한 클릭 이벤트 핸들러 등록 (이벤트 위임 사용)
        $(document).on('click', '.close_btn', function(event) {
            event.preventDefault(); // 기본 동작 방지
            console.log('팝업 닫기 버튼이 클릭되었습니다.'); // 콘솔에 메시지 출력
            closePopup('#pop_txt1');
        });

        // loadCategoryData 함수 정의
        function loadCategoryData(검색어) {
            const encodedSearchQuery = encodeURIComponent(검색어);
            console.log('클릭한 카테고리:', encodedSearchQuery); // 클릭한 카테고리 콘솔 출력

            $.ajax({
                url: '/category', // 실제 데이터 요청 URL로 변경해야 합니다.
                type: 'GET',
                data: { searchQuery: 검색어 }, // 'searchQuery'로 파라미터 설정
                success: function(data) {
                    let popupContent = "";
                    if (Array.isArray(data) && data.length > 0) { // 배열이고 데이터가 존재하는지 확인
                        console.log('데이터:', data); // 받아온 데이터 콘솔 출력
                        // 받아온 데이터를 화면에 표시
                        data.forEach(function(item) {
                            popupContent += `<p class="pop_button" onclick="showRecipe('${item.항목일련번호}')">${item.이름}</p>`;
                        });
                    } else {
                        popupContent = "<p>해당 카테고리에 대한 데이터가 존재하지 않습니다.</p>";
                    }
                    $('#popup-list').html(popupContent); // 팝업 창에 데이터 삽입
                    openPopup('#pop_txt1'); // 해당 카테고리의 팝업 열기
                },
                error: function() {
                    console.error('데이터를 불러오는 중 오류가 발생했습니다.');
                    $('#popup-list').html("<p>데이터를 불러오는 중 오류가 발생했습니다.</p>");
                }
            });
        }

        $('.category-link').click(function(event) {
            event.preventDefault(); // 기본 동작(링크 이동) 방지

            // 클릭한 요소의 data-category 속성 값을 가져옴
            const category = $(this).data('category');

            // URL 업데이트
            const newUrl = '/?searchQuery=' + encodeURIComponent(category);
            history.pushState({ category: category }, null, newUrl);

            // 서버에 데이터 요청 및 화면 업데이트
            loadCategoryData(category);
        });

        // 팝업창 닫기 이벤트 등록
        $(window).on('popstate', function(event) {
            const currentState = history.state;
            if (!currentState || !currentState.category) {
                closePopup('#pop_txt1');
            }
        });
    });

    // 팝업창 열기
    function openPopup(obj) {
        console.log("팝업 열기:", obj); // 팝업 열기 확인
        $(".layer_pop_txt").hide();
        $(obj).show();
    }

    // 팝업창 닫기
    function closePopup(obj) {
        console.log("팝업 닫기:", obj); // 팝업 닫기 확인
        const element = $(obj);
        console.log("요소 확인:", element); // 요소 확인
        element.hide(); // jQuery hide() 메서드 사용
        const url = new URL(window.location.href);
        const searchParams = new URLSearchParams(url.search);
        searchParams.delete('searchQuery'); // URL에서 searchQuery 파라미터 제거
        url.search = searchParams.toString();
        window.history.pushState({}, '', url.toString().split('#')[0]); // URL에서 해시 부분 제거

        // 검색 결과 초기화
        $('#searchInput').val('');
        $('#searchResults').empty();
        $('#searchPopup').hide();
    }

    function showRecipe(항목일련번호) {
        const newUrl = '/recipe-data/' + 항목일련번호; // 데이터 요청을 위한 URL
        history.pushState({}, null, '/recipe/' + 항목일련번호); // URL 변경

        $.ajax({
            url: newUrl,
            type: 'GET',
            success: function(data) {
                console.log(data);
                displayRecipe(data);
            },
            error: function() {
                console.error('데이터 요청 중 에러가 발생했습니다.');
            }
        });
    }

    function displayRecipe(data) {
        let recipeContent = `
        <div>
            <div class="r-card tac">
                <div class="r-nevi-icon">
                    ${data.base.항목일련번호 > 1 ?
            `<div style="visibility: visible;">
                            <a href="/recipe/${data.base.항목일련번호 - 1}" class="fs32 grey55"><</a>
                        </div>` :
            `<div style="visibility: hidden;">
                            <a class="fs32 grey55"><</a>
                        </div>`
        }
                    <div id="currentItemNumber" class="fs36 lsm25 fw1 mt2 grey55">${data.base.항목일련번호}</div>
                    <div>
                        <a href="/recipe/${data.base.항목일련번호 + 1}" class="fs32 grey55">></a>
                    </div>
                </div>
                <div class="ulm"></div>
                <div>
                    <div id="category" class="fs24 lsm10 mt1 grey77">${data.base.카테고리}</div>
                    <div id="recipeName" class="fs48 lsm25 mtm05 mb1">${data.base.이름}</div>
                </div>
                <div id="effects" class="r-effect">
                    ${data.effect.map(effect => `
                        <div class="r-effect-round r-c-bg1">
                            <a href="#;" class="effect-link" data-effect="${effect.효과}" style="color:white;">${effect.효과}</a>
                        </div>`).join('')}
                </div>
                <div class="containerb">
                    <div class="layer_pop_txt" id="pop_txt1">
                        <div class="pop_content">
                            <div class="title"></div>
                            <ul id="effectsList" class="popup-list grey55"></ul>
                            <div><a class="close_btn" href="javascript:void(0);" onclick="closePopup('#pop_txt1')">닫기</a></div>
                        </div>
                    </div>
                </div>
                <div class="fw5 fs24 grey77 mt2"> 재료</div>
                <div class="ulm"></div>
                <div id="ingredients">
                    ${data.ingredient.map(ingredient => `
                        <div class="r-icon lsm10 mt05">
                            <div class="r-icond">
                                <img src="/imgs/${ingredient.목록아이콘}">
                            </div>
                            <div class="tal grey55">${ingredient.재료목록}</div>
                        </div>`).join('')}
                </div>
                <div id="mainImage" class="r-image">
                    <img src="/imgs/${data.base.메인이미지}">
                </div>
                <div class="fw5 fs24 grey77">만드는 순서</div>
                <div class="ulm"></div>
                <div id="recipeStepsContainer">
                    ${data.recipe.map(step => `
                        <div class="tal grey55 pl2 pr2">
                            <span>${step.조리순서}</span> <span>${step.조리법}</span>
                        </div>`).join('')}
                </div>
                <div class="ulm"></div>
                <a href="/" class="grey55">
                    <div class="r-main-btn mt2 mb2">처음으로</div>
                </a>
            </div>
        </div>`;

        $('#recipeContent').html(recipeContent);
        // 팝업을 닫기 위해 closePopup 함수 호출
        closePopup('#pop_txt1');
    }

</script>
</body>
</html>